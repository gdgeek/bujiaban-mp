name: PR Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check commit messages
        run: |
          # æ£€æŸ¥æäº¤ä¿¡æ¯æ ¼å¼ (Conventional Commits)
          echo "æ£€æŸ¥æäº¤ä¿¡æ¯æ ¼å¼..."
          git log --oneline ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | while read line; do
            if ! echo "$line" | grep -qE "^[a-f0-9]+ (feat|fix|docs|style|refactor|test|chore|perf|ci|build)(\(.+\))?: .+"; then
              echo "âŒ æäº¤ä¿¡æ¯æ ¼å¼ä¸ç¬¦åˆè§„èŒƒ: $line"
              echo "è¯·ä½¿ç”¨æ ¼å¼: type(scope): description"
              echo "ä¾‹å¦‚: feat(user): add login functionality"
              exit 1
            fi
          done

      - name: Check file changes
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰æ•æ„Ÿæ–‡ä»¶å˜æ›´
          changed_files=$(git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }})

          # æ£€æŸ¥æ˜¯å¦ä¿®æ”¹äº†é…ç½®æ–‡ä»¶
          if echo "$changed_files" | grep -E "\.(env|config)\." > /dev/null; then
            echo "âš ï¸  æ£€æµ‹åˆ°é…ç½®æ–‡ä»¶å˜æ›´ï¼Œè¯·ç¡®è®¤æ˜¯å¦éœ€è¦æ›´æ–°ç¯å¢ƒå˜é‡"
          fi

          # æ£€æŸ¥æ˜¯å¦æœ‰å¤§æ–‡ä»¶
          for file in $changed_files; do
            if [ -f "$file" ] && [ $(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null || echo 0) -gt 1048576 ]; then
              echo "âŒ æ–‡ä»¶è¿‡å¤§ (>1MB): $file"
              exit 1
            fi
          done

      - name: TypeScript type check
        run: pnpm run tsc

      - name: ESLint check
        run: pnpm run lint

      - name: Run tests
        run: pnpm run test

      - name: Build check
        run: pnpm run build:h5
        env:
          VITE_API_URL: "https://api.example.com"
          VITE_CLOUD_ENV: "test-env"
          VITE_HASH_SALT: "test-salt"

      - name: Check bundle size
        run: |
          # æ£€æŸ¥æ„å»ºäº§ç‰©å¤§å°
          if [ -d "dist" ]; then
            size=$(du -sh dist | cut -f1)
            echo "ğŸ“¦ æ„å»ºäº§ç‰©å¤§å°: $size"

            # å¦‚æœå¤§å°è¶…è¿‡ 10MB ç»™å‡ºè­¦å‘Š
            size_bytes=$(du -sb dist | cut -f1)
            if [ $size_bytes -gt 10485760 ]; then
              echo "âš ï¸  æ„å»ºäº§ç‰©è¾ƒå¤§ï¼Œè¯·æ£€æŸ¥æ˜¯å¦åŒ…å«ä¸å¿…è¦çš„æ–‡ä»¶"
            fi
          fi

      - name: Comment PR
        uses: actions/github-script@v6
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' && comment.body.includes('ğŸ¤– PR æ£€æŸ¥ç»“æœ')
            );

            const body = `ğŸ¤– PR æ£€æŸ¥ç»“æœ

            âœ… TypeScript ç±»å‹æ£€æŸ¥é€šè¿‡
            âœ… ESLint ä»£ç è§„èŒƒæ£€æŸ¥é€šè¿‡
            âœ… å•å…ƒæµ‹è¯•é€šè¿‡
            âœ… æ„å»ºæ£€æŸ¥é€šè¿‡

            ğŸ“Š æ£€æŸ¥ç»Ÿè®¡:
            - æäº¤æ•°é‡: ${{ github.event.pull_request.commits }}
            - æ–‡ä»¶å˜æ›´: +${{ github.event.pull_request.additions }} -${{ github.event.pull_request.deletions }}

            ğŸš€ æ­¤ PR å·²å‡†å¤‡å¥½åˆå¹¶ï¼`;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

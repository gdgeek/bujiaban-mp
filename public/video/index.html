<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>视频管理</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu,
          Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
        background-color: #f5f5f5;
        color: #333;
        padding: 12px;
      }
      .container {
        max-width: 100%;
      }
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }
      .header h1 {
        font-size: 18px;
        font-weight: 600;
      }
      .btn {
        background-color: #007aff;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
      }
      .video-list {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      .video-card {
        background-color: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }
      .video-thumb {
        width: 100%;
        height: 220px;
        position: relative;
        overflow: hidden;
        background-color: #000;
      }
      .video-thumb video {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }
      .video-duration {
        position: absolute;
        top: 8px;
        right: 8px;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 4px 6px;
        border-radius: 4px;
        font-size: 12px;
        z-index: 1;
      }
      .video-info {
        padding: 12px;
      }
      .video-title {
        font-size: 16px;
        font-weight: 500;
        margin-bottom: 8px;
      }
      .video-meta {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        color: #666;
      }
      .video-actions {
        display: flex;
        border-top: 1px solid #eee;
      }
      .video-action {
        flex: 1;
        text-align: center;
        padding: 8px 0;
        font-size: 14px;
        color: #007aff;
        cursor: pointer;
      }
      .video-action:not(:last-child) {
        border-right: 1px solid #eee;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="container">
        <div class="header">
          <h1>视频管理</h1>
          <button class="btn" @click="handleAddVideo">添加视频</button>
        </div>

        <div class="video-list">
          <div v-for="video in videos" :key="video.id" class="video-card" :data-id="video.id">
            <div class="video-thumb">
              <video
                @click="handleVideoClick($event, video.id)"
                :src="video.videoUrl"
                :poster="video.thumbnail"
                preload="metadata"
                :controls="isPlaying[video.id]"
                playsinline
                @loadedmetadata="handleVideoMetadata($event, video.id)"
              ></video>
              <div class="video-duration">{{ videoDurations[video.id] || '加载中...' }}</div>
            </div>
            <div class="video-info">
              <div class="video-title">{{ video.title }}</div>
              <div class="video-meta">
                <span>上传日期: {{ video.uploadDate }}</span>
                <span>{{ video.views }} 次观看</span>
              </div>
            </div>
            <div class="video-actions">
              <div class="video-action" @click="handleEditVideo(video.id)">编辑</div>
              <div class="video-action" @click="handlePlayVideo(video.id)">播放</div>
              <div class="video-action" @click="handleDeleteVideo(video.id)">删除</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      /**
       * @typedef {Object} Video
       * @property {number} id - 视频ID
       * @property {string} title - 视频标题
       * @property {string} thumbnail - 视频缩略图URL
       * @property {string} videoUrl - 视频URL
       * @property {string} uploadDate - 上传日期
       * @property {number} views - 观看次数
       */

      const { createApp, ref, onMounted } = Vue;

      const app = createApp({
        setup() {
          // 视频数据
          const videos = ref([
            {
              id: 1,
              title: "如何高效管理工作时间 - 不加班指南",
              thumbnail: "https://picsum.photos/700/400",
              videoUrl: "https://vjs.zencdn.net/v/oceans.mp4",
              uploadDate: "2023-05-15",
              views: 1254,
            },
            {
              id: 2,
              title: "团队协作工具使用技巧",
              thumbnail: "https://picsum.photos/700/400",
              videoUrl: "https://vjs.zencdn.net/v/oceans.mp4",
              uploadDate: "2023-06-22",
              views: 857,
            },
            {
              id: 3,
              title: "远程办公效率提升方法",
              thumbnail: "https://picsum.photos/700/400",
              videoUrl: "https://vjs.zencdn.net/v/oceans.mp4",
              uploadDate: "2023-07-30",
              views: 2104,
            },
            {
              id: 4,
              title: "工作与生活平衡的秘诀",
              thumbnail: "https://picsum.photos/700/400",
              videoUrl: "https://vjs.zencdn.net/v/oceans.mp4",
              uploadDate: "2023-08-12",
              views: 1732,
            },
          ]);

          // 视频播放状态
          const isPlaying = ref({});

          // 视频实际时长
          const videoDurations = ref({});

          // 格式化时间为 MM:SS 格式
          const formatDuration = (seconds) => {
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes.toString().padStart(2, "0")}:${secs.toString().padStart(2, "0")}`;
          };

          // 处理视频元数据加载事件
          const handleVideoMetadata = (event, videoId) => {
            const duration = event.target.duration;
            videoDurations.value[videoId] = formatDuration(duration);
          };

          // 向小程序发送消息
          const sendMessageToMiniProgram = (data) => {
            // 微信小程序环境
            if (window.wx && window.wx.miniProgram) {
              window.wx.miniProgram.postMessage({
                data: data,
              });
            } else {
              // 开发调试环境
              console.log("向小程序发送消息:", data);
            }
          };

          // 处理添加视频
          const handleAddVideo = () => {
            alert("添加新视频");
            // 向小程序发送消息
            sendMessageToMiniProgram({
              action: "add",
            });
          };

          // 处理编辑视频
          const handleEditVideo = (videoId) => {
            alert(`编辑视频 ID: ${videoId}`);
            // 向小程序发送消息
            sendMessageToMiniProgram({
              action: "edit",
              videoId: videoId,
            });
          };

          // 处理删除视频
          const handleDeleteVideo = (videoId) => {
            if (confirm(`确定要删除视频 ID: ${videoId} 吗?`)) {
              // 删除视频
              const index = videos.value.findIndex((v) => v.id === videoId);
              if (index !== -1) {
                videos.value.splice(index, 1);
                // 向小程序发送消息
                sendMessageToMiniProgram({
                  action: "delete",
                  videoId: videoId,
                });
              }
            }
          };

          // 处理播放视频
          const handlePlayVideo = (videoId) => {
            const video = videos.value.find((v) => v.id === videoId);
            if (video) {
              // 向小程序发送消息
              sendMessageToMiniProgram({
                action: "play",
                videoId: videoId,
                videoUrl: video.videoUrl,
              });

              // 在当前页面播放视频
              const videoElements = document.querySelectorAll("video");
              videoElements.forEach((v) => {
                const vId = v.parentElement.parentElement.getAttribute("data-id");
                if (vId !== videoId.toString()) {
                  v.pause(); // 暂停其他视频
                  isPlaying.value[vId] = false;
                }
              });

              const targetVideo = document.querySelector(`.video-card[data-id="${videoId}"] video`);
              if (targetVideo) {
                if (targetVideo.paused) {
                  targetVideo.play();
                  isPlaying.value[videoId] = true;
                } else {
                  targetVideo.pause();
                  isPlaying.value[videoId] = false;
                }
              }
            }
          };

          // 处理视频点击
          const handleVideoClick = (event, videoId) => {
            // 阻止冒泡，避免重复处理
            event.stopPropagation();

            const videoElement = event.target;
            if (videoElement.paused) {
              videoElement.play();
              isPlaying.value[videoId] = true;

              // 暂停其他视频
              const videoElements = document.querySelectorAll("video");
              videoElements.forEach((v) => {
                const vId = v.parentElement.parentElement.getAttribute("data-id");
                if (vId !== videoId.toString() && !v.paused) {
                  v.pause();
                  isPlaying.value[vId] = false;
                }
              });
            } else {
              videoElement.pause();
              isPlaying.value[videoId] = false;
            }
          };

          // 监听小程序消息
          onMounted(() => {
            window.addEventListener("message", (event) => {
              console.log("收到小程序消息:", event.data);
              // 这里可以根据消息内容执行相应操作
            });

            // 添加所有视频的事件监听
            setTimeout(() => {
              const videoElements = document.querySelectorAll("video");
              videoElements.forEach((video) => {
                const videoId = video.parentElement.parentElement.getAttribute("data-id");

                video.addEventListener("play", () => {
                  isPlaying.value[videoId] = true;
                });

                video.addEventListener("pause", () => {
                  isPlaying.value[videoId] = false;
                });

                video.addEventListener("ended", () => {
                  isPlaying.value[videoId] = false;
                });
              });
            }, 500);
          });

          // 返回需要在模板中使用的数据和方法
          return {
            videos,
            isPlaying,
            videoDurations,
            handleAddVideo,
            handleEditVideo,
            handleDeleteVideo,
            handlePlayVideo,
            handleVideoClick,
            handleVideoMetadata,
          };
        },
      });

      // 挂载应用
      app.mount("#app");
    </script>
  </body>
</html>
